# 系统设置

<cite>
**本文档引用的文件**   
- [config.go](file://setting/config/config.go)
- [console_setting.go](file://setting/console_setting/config.go)
- [discord.go](file://setting/system_setting/discord.go)
- [oidc.go](file://setting/system_setting/oidc.go)
- [passkey.go](file://setting/system_setting/passkey.go)
- [legal.go](file://setting/system_setting/legal.go)
- [fetch_setting.go](file://setting/system_setting/fetch_setting.go)
- [validation.go](file://setting/console_setting/validation.go)
- [option.go](file://controller/option.go)
- [model.go](file://model/option.go)
- [env.go](file://common/env.go)
</cite>

## 目录
1. [系统设置](#系统设置)
2. [配置管理架构](#配置管理架构)
3. 第三方集成配置
   - [Discord集成](#discord集成)
   - [OIDC集成](#oidc集成)
   - [Passkey集成](#passkey集成)
4. 法律文本管理
   - [用户协议与隐私政策](#用户协议与隐私政策)
5. 全局参数配置
   - [系统公告](#系统公告)
   - [服务地址](#服务地址)
6. 配置机制详解
   - [配置注册与加载](#配置注册与加载)
   - [前端与后端映射](#前端与后端映射)
   - [动态更新与热加载](#动态更新与热加载)
7. 高级特性
   - [默认值管理](#默认值管理)
   - [安全敏感字段处理](#安全敏感字段处理)

## 配置管理架构

系统采用分层配置管理架构，通过`ConfigManager`统一管理所有配置模块。该架构实现了配置的模块化、可扩展性和运行时动态更新能力。

```mermaid
classDiagram
class ConfigManager {
+configs map[string]interface{}
+mutex sync.RWMutex
+Register(name string, config interface{})
+Get(name string) interface{}
+LoadFromDB(options map[string]string) error
+SaveToDB(updateFunc func(key, value string) error) error
}
class ConsoleSetting {
+ApiInfo string
+UptimeKumaGroups string
+Announcements string
+FAQ string
+ApiInfoEnabled bool
+UptimeKumaEnabled bool
+AnnouncementsEnabled bool
+FAQEnabled bool
}
class DiscordSettings {
+Enabled bool
+ClientId string
+ClientSecret string
}
class OIDCSettings {
+Enabled bool
+ClientId string
+ClientSecret string
+WellKnown string
+AuthorizationEndpoint string
+TokenEndpoint string
+UserInfoEndpoint string
}
class PasskeySettings {
+Enabled bool
+RPDisplayName string
+RPID string
+Origins string
+AllowInsecureOrigin bool
+UserVerification string
+AttachmentPreference string
}
class LegalSettings {
+UserAgreement string
+PrivacyPolicy string
}
class FetchSetting {
+EnableSSRFProtection bool
+AllowPrivateIp bool
+DomainFilterMode bool
+IpFilterMode bool
+DomainList []string
+IpList []string
+AllowedPorts []string
+ApplyIPFilterForDomain bool
}
ConfigManager --> ConsoleSetting : "注册"
ConfigManager --> DiscordSettings : "注册"
ConfigManager --> OIDCSettings : "注册"
ConfigManager --> PasskeySettings : "注册"
ConfigManager --> LegalSettings : "注册"
ConfigManager --> FetchSetting : "注册"
```

**图源**
- [config.go](file://setting/config/config.go#L13-L288)
- [console_setting.go](file://setting/console_setting/config.go#L5-L14)
- [discord.go](file://setting/system_setting/discord.go#L5-L9)
- [oidc.go](file://setting/system_setting/oidc.go#L5-L13)
- [passkey.go](file://setting/system_setting/passkey.go#L11-L19)
- [legal.go](file://setting/system_setting/legal.go#L5-L8)
- [fetch_setting.go](file://setting/system_setting/fetch_setting.go#L5-L14)

**配置管理架构**
- [config.go](file://setting/config/config.go#L13-L288)
- [console_setting.go](file://setting/console_setting/config.go#L5-L40)
- [discord.go](file://setting/system_setting/discord.go#L5-L22)

## 第三方集成配置

### Discord集成

Discord集成允许用户通过Discord账户进行身份验证和绑定。配置通过`DiscordSettings`结构体管理，包含启用状态、客户端ID和密钥。

```mermaid
sequenceDiagram
participant 前端 as 前端界面
participant 后端 as 后端API
participant 数据库 as 数据库
participant Discord as Discord OAuth
前端->>后端 : 获取Discord配置
后端->>数据库 : 查询discord.enabled, client_id, client_secret
数据库-->>后端 : 返回配置值
后端-->>前端 : 返回配置
前端->>后端 : 更新Discord配置
后端->>后端 : 验证ClientId是否为空
后端->>数据库 : 保存配置
数据库-->>后端 : 保存成功
后端-->>前端 : 返回结果
前端->>Discord : 用户点击Discord登录
Discord-->>前端 : 重定向到Discord授权页面
前端->>后端 : 处理OAuth回调
后端->>后端 : 验证配置启用状态
后端->>Discord : 交换访问令牌
Discord-->>后端 : 返回用户信息
后端->>数据库 : 创建/更新用户
数据库-->>后端 : 操作结果
后端-->>前端 : 登录成功
```

**图源**
- [discord.go](file://setting/system_setting/discord.go#L5-L22)
- [option.go](file://controller/option.go#L74-L81)
- [controller.go](file://controller/discord.go)

**Discord集成配置**
- [discord.go](file://setting/system_setting/discord.go#L5-L22)
- [option.go](file://controller/option.go#L74-L81)

### OIDC集成

OIDC（OpenID Connect）集成提供标准化的单点登录功能。配置通过`OIDCSettings`结构体管理，包含启用状态、客户端凭证和OIDC发现端点信息。

```mermaid
flowchart TD
A[开始] --> B{OIDC已启用?}
B --> |否| C[显示错误: 未启用OIDC]
B --> |是| D{ClientId已配置?}
D --> |否| E[显示错误: 请先配置ClientId]
D --> |是| F[初始化OIDC Provider]
F --> G[生成授权URL]
G --> H[重定向到OIDC提供方]
H --> I[用户授权]
I --> J[回调处理]
J --> K[验证state参数]
K --> L[交换访问令牌]
L --> M[获取用户信息]
M --> N[创建/更新用户]
N --> O[登录成功]
```

**图源**
- [oidc.go](file://setting/system_setting/oidc.go#L5-L26)
- [option.go](file://controller/option.go#L82-L88)
- [controller.go](file://controller/oidc.go)

**OIDC集成配置**
- [oidc.go](file://setting/system_setting/oidc.go#L5-L26)
- [option.go](file://controller/option.go#L82-L88)

### Passkey集成

Passkey集成提供无密码身份验证功能。配置通过`PasskeySettings`结构体管理，包含启用状态、依赖方信息和安全策略。

```mermaid
sequenceDiagram
participant 前端 as 前端界面
participant 后端 as 后端API
participant 数据库 as 数据库
前端->>后端 : 请求Passkey注册
后端->>后端 : 获取Passkey配置
后端->>后端 : 验证RPID是否为空
后端->>后端 : 从ServerAddress提取域名
后端->>后端 : 构建WebAuthn配置
后端-->>前端 : 返回注册挑战
前端->>后端 : 提交注册响应
后端->>后端 : 验证注册响应
后端->>数据库 : 存储凭证
数据库-->>后端 : 存储结果
后端-->>前端 : 注册成功
前端->>后端 : 请求Passkey登录
后端->>数据库 : 查询用户凭证
数据库-->>后端 : 返回凭证
后端->>后端 : 构建登录挑战
后端-->>前端 : 返回登录挑战
前端->>后端 : 提交登录响应
后端->>后端 : 验证登录响应
后端->>后端 : 生成会话
后端-->>前端 : 登录成功
```

**图源**
- [passkey.go](file://setting/system_setting/passkey.go#L11-L51)
- [service.go](file://service/passkey/service.go)
- [controller.go](file://controller/passkey.go)

**Passkey集成配置**
- [passkey.go](file://setting/system_setting/passkey.go#L11-L51)
- [service.go](file://service/passkey/service.go)
- [controller.go](file://controller/passkey.go)

## 法律文本管理

### 用户协议与隐私政策

系统通过`LegalSettings`结构体管理用户协议和隐私政策内容。这些文本内容存储在数据库中，可通过管理界面进行更新。

```mermaid
classDiagram
class LegalSettings {
+UserAgreement string
+PrivacyPolicy string
}
class UserAgreementPage {
+显示用户协议
+获取最新协议内容
}
class PrivacyPolicyPage {
+显示隐私政策
+获取最新政策内容
}
LegalSettings --> UserAgreementPage : "提供内容"
LegalSettings --> PrivacyPolicyPage : "提供内容"
UserAgreementPage --> 前端 : "渲染"
PrivacyPolicyPage --> 前端 : "渲染"
```

**图源**
- [legal.go](file://setting/system_setting/legal.go#L5-L22)
- [pages.go](file://web/src/pages/UserAgreement/index.jsx)
- [pages.go](file://web/src/pages/PrivacyPolicy/index.jsx)

**法律文本管理**
- [legal.go](file://setting/system_setting/legal.go#L5-L22)
- [pages.go](file://web/src/pages/UserAgreement/index.jsx)
- [pages.go](file://web/src/pages/PrivacyPolicy/index.jsx)

## 全局参数配置

### 系统公告

系统公告配置通过`ConsoleSetting`结构体管理，支持JSON格式的公告数组，包含内容、发布日期、类型和附加信息。

```mermaid
flowchart TD
A[前端输入公告] --> B[验证JSON格式]
B --> C{验证通过?}
C --> |否| D[返回格式错误]
C --> |是| E[验证每个公告字段]
E --> F{所有字段有效?}
F --> |否| G[返回具体错误]
F --> |是| H[按发布日期排序]
H --> I[保存到数据库]
I --> J[前端获取公告]
J --> K[按时间倒序显示]
```

**图源**
- [console_setting.go](file://setting/console_setting/config.go#L5-L14)
- [validation.go](file://setting/console_setting/validation.go#L141-L184)
- [dashboard.jsx](file://web/src/components/dashboard/AnnouncementsPanel.jsx)

**系统公告配置**
- [console_setting.go](file://setting/console_setting/config.go#L5-L14)
- [validation.go](file://setting/console_setting/validation.go#L141-L184)

### 服务地址

服务地址（ServerAddress）是系统的关键全局参数，影响支付回调、Passkey认证等多个功能模块。

```mermaid
sequenceDiagram
participant 前端 as 前端界面
participant 后端 as 后端API
participant 数据库 as 数据库
前端->>后端 : 获取当前配置
后端->>数据库 : 查询ServerAddress
数据库-->>后端 : 返回地址
后端-->>前端 : 显示地址
前端->>后端 : 提交新地址
后端->>后端 : 移除末尾斜杠
后端->>数据库 : 保存新地址
数据库-->>后端 : 保存成功
后端-->>前端 : 更新成功
后端->>Passkey : Passkey配置使用新地址
后端->>支付系统 : 支付回调使用新地址
后端->>前端 : 前端缓存新地址
```

**图源**
- [system_setting.go](file://setting/system_setting/passkey.go#L36-L48)
- [option.go](file://controller/option.go)
- [settings.jsx](file://web/src/pages/Setting/Payment/SettingsGeneralPayment.jsx)

**服务地址配置**
- [passkey.go](file://setting/system_setting/passkey.go#L36-L48)
- [option.go](file://controller/option.go)
- [SettingsGeneralPayment.jsx](file://web/src/pages/Setting/Payment/SettingsGeneralPayment.jsx)

## 配置机制详解

### 配置注册与加载

系统采用`ConfigManager`设计模式实现配置的统一管理。所有配置模块在初始化时注册到全局配置管理器，通过反射机制实现配置的序列化和反序列化。

```mermaid
sequenceDiagram
participant 初始化 as 系统初始化
participant ConfigManager as 配置管理器
participant 数据库 as 数据库
初始化->>ConfigManager : 创建GlobalConfig实例
初始化->>各配置模块 : 调用init函数
各配置模块->>ConfigManager : Register("模块名", 配置实例)
ConfigManager->>ConfigManager : 存储配置到configs映射
初始化->>数据库 : 加载所有选项
数据库-->>初始化 : 返回选项映射
初始化->>ConfigManager : LoadFromDB(选项映射)
ConfigManager->>ConfigManager : 遍历注册的配置
loop 每个配置模块
ConfigManager->>ConfigManager : 提取以"模块名."开头的选项
ConfigManager->>ConfigManager : 构建配置子映射
ConfigManager->>ConfigManager : updateConfigFromMap(配置, 子映射)
end
```

**图源**
- [config.go](file://setting/config/config.go#L27-L68)
- [console_setting.go](file://setting/console_setting/config.go#L31-L34)
- [model.go](file://model/option.go#L149-L152)

**配置注册与加载机制**
- [config.go](file://setting/config/config.go#L27-L68)
- [console_setting.go](file://setting/console_setting/config.go#L31-L34)
- [model.go](file://model/option.go#L149-L152)

### 前端与后端映射

系统通过`console_setting.announcements`等键名实现前端界面与后端配置的映射。前端通过API获取配置，后端将配置存储在数据库中。

```mermaid
flowchart LR
A[前端组件] --> B[API调用]
B --> C{API端点}
C --> |GET /api/option| D[获取所有配置]
C --> |PUT /api/option| E[更新特定配置]
D --> F[过滤敏感字段]
F --> G[返回配置列表]
E --> H[验证配置值]
H --> I[更新数据库]
I --> J[更新内存映射]
J --> K[返回结果]
G --> A
K --> A
```

**图源**
- [option.go](file://controller/option.go)
- [model.go](file://model/option.go#L176-L190)
- [settings.jsx](file://web/src/components/settings/SystemSetting.jsx)

**前端与后端映射**
- [option.go](file://controller/option.go)
- [model.go](file://model/option.go#L176-L190)
- [SystemSetting.jsx](file://web/src/components/settings/SystemSetting.jsx)

### 动态更新与热加载

系统实现配置的动态更新和热加载机制，无需重启服务即可应用新配置。通过`SyncOptions`函数定期从数据库同步配置。

```mermaid
sequenceDiagram
participant 前端 as 前端界面
participant API as API控制器
participant 配置系统 as 配置系统
participant 数据库 as 数据库
participant 定时器 as 配置同步定时器
前端->>API : 更新配置请求
API->>数据库 : 保存配置到数据库
数据库-->>API : 保存成功
API->>配置系统 : updateOptionMap(键, 值)
配置系统->>配置系统 : 更新内存中的OptionMap
配置系统->>配置系统 : handleConfigUpdate(处理分层配置)
配置系统-->>API : 更新完成
API-->>前端 : 返回成功
定时器->>数据库 : 定期查询所有配置
数据库-->>定时器 : 返回最新配置
定时器->>配置系统 : 更新内存中的OptionMap
定时器->>配置系统 : 触发配置更新事件
```

**图源**
- [model.go](file://model/option.go#L168-L174)
- [option.go](file://controller/option.go#L213-L217)
- [model.go](file://model/option.go#L455-L478)

**动态更新与热加载**
- [model.go](file://model/option.go#L168-L174)
- [option.go](file://controller/option.go#L213-L217)
- [model.go](file://model/option.go#L455-L478)

## 高级特性

### 默认值管理

系统为所有配置提供合理的默认值，确保在未配置时系统仍能正常运行。默认值在配置结构体的变量声明中定义。

```mermaid
classDiagram
class FetchSetting {
+EnableSSRFProtection bool = true
+AllowPrivateIp bool = false
+DomainFilterMode bool = false
+IpFilterMode bool = false
+DomainList []string = []
+IpList []string = []
+AllowedPorts []string = ["80", "443", "8080", "8443"]
+ApplyIPFilterForDomain bool = false
}
class PasskeySettings {
+Enabled bool = false
+RPDisplayName string = SystemName
+RPID string = ""
+Origins string = ""
+AllowInsecureOrigin bool = false
+UserVerification string = "preferred"
+AttachmentPreference string = ""
}
class ConsoleSetting {
+ApiInfoEnabled bool = true
+UptimeKumaEnabled bool = true
+AnnouncementsEnabled bool = true
+FAQEnabled bool = true
}
```

**图源**
- [fetch_setting.go](file://setting/system_setting/fetch_setting.go#L16-L25)
- [passkey.go](file://setting/system_setting/passkey.go#L21-L29)
- [console_setting.go](file://setting/console_setting/config.go#L17-L26)

**默认值管理**
- [fetch_setting.go](file://setting/system_setting/fetch_setting.go#L16-L25)
- [passkey.go](file://setting/system_setting/passkey.go#L21-L29)
- [console_setting.go](file://setting/console_setting/config.go#L17-L26)

### 安全敏感字段处理

系统对安全敏感字段（如令牌、密钥）进行特殊处理，防止在API响应中泄露。通过`GetOptions`函数过滤敏感字段。

```mermaid
flowchart TD
A[请求获取配置] --> B[获取所有选项]
B --> C[遍历选项映射]
C --> D{键名以Token/Secret/Key结尾?}
D --> |是| E[跳过该选项]
D --> |否| F[包含在响应中]
F --> G{处理完成?}
G --> |否| C
G --> |是| H[返回过滤后的配置]
```

**图源**
- [option.go](file://controller/option.go#L23-L30)
- [env.go](file://common/env.go)
- [constants.go](file://common/constants.go)

**安全敏感字段处理**
- [option.go](file://controller/option.go#L23-L30)
- [env.go](file://common/env.go)
- [constants.go](file://common/constants.go)