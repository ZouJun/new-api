# 配置指南

<cite>
**本文档中引用的文件**  
- [.env.example](file://.env.example)
- [setting/config/config.go](file://setting/config/config.go)
- [constant/env.go](file://constant/env.go)
- [common/env.go](file://common/env.go)
- [setting/system_setting/system_setting_old.go](file://setting/system_setting/system_setting_old.go)
- [setting/operation_setting/operation_setting.go](file://setting/operation_setting/operation_setting.go)
- [setting/rate_limit.go](file://setting/rate_limit.go)
- [setting/sensitive.go](file://setting/sensitive.go)
- [setting/console_setting/config.go](file://setting/console_setting/config.go)
- [setting/system_setting/oidc.go](file://setting/system_setting/oidc.go)
- [setting/operation_setting/payment_setting.go](file://setting/operation_setting/payment_setting.go)
- [setting/operation_setting/monitor_setting.go](file://setting/operation_setting/monitor_setting.go)
- [setting/model_setting/global.go](file://setting/model_setting/global.go)
- [setting/ratio_setting/expose_ratio.go](file://setting/ratio_setting/expose_ratio.go)
- [setting/operation_setting/tools.go](file://setting/operation_setting/tools.go)
- [setting/payment_stripe.go](file://setting/payment_stripe.go)
- [setting/payment_creem.go](file://setting/payment_creem.go)
</cite>

## 目录
1. [简介](#简介)
2. [环境变量配置](#环境变量配置)
3. [数据库配置](#数据库配置)
4. [缓存配置](#缓存配置)
5. [安全设置](#安全设置)
6. [监控与告警](#监控与告警)
7. [运营设置](#运营设置)
8. [高级功能配置](#高级功能配置)
9. [支付网关设置](#支付网关设置)
10. [OIDC认证配置](#oidc认证配置)
11. [配置生效方式与风险](#配置生效方式与风险)
12. [配置文件示例](#配置文件示例)
13. [最佳实践建议](#最佳实践建议)

## 简介
本配置指南详细说明了系统的各项配置项，包括环境变量、数据库配置、安全设置、监控告警、运营设置以及高级功能配置。文档解释了每个配置参数的作用、可选值和默认值，并提供了完整的配置示例和最佳实践建议。涵盖了速率限制、敏感词过滤、OIDC认证和支付网关等高级配置。

**Section sources**
- [.env.example](file://.env.example)
- [setting/config/config.go](file://setting/config/config.go)

## 环境变量配置
环境变量是系统运行的基础配置，通过`.env`文件或环境变量设置。以下是主要环境变量的详细说明：

### 基础配置
- **PORT**: 服务监听端口，默认为3000
- **FRONTEND_BASE_URL**: 前端基础URL，用于重定向和链接生成

### 调试配置
- **ENABLE_PPROF**: 是否启用pprof性能分析，默认为false
- **DEBUG**: 是否启用调试模式，默认为false

### 数据库连接配置
- **SQL_DSN**: 主数据库连接字符串，格式为`user:password@tcp(127.0.0.1:3306)/dbname?parseTime=true`
- **LOG_SQL_DSN**: 日志数据库连接字符串
- **SQLITE_PATH**: SQLite数据库文件路径

### 缓存配置
- **REDIS_CONN_STRING**: Redis连接字符串，格式为`redis://user:password@localhost:6379/0`
- **MEMORY_CACHE_ENABLED**: 是否启用内存缓存，默认为true

### 任务与超时配置
- **RELAY_TIMEOUT**: 所有请求的超时时间（秒），0表示不限制
- **STREAMING_TIMEOUT**: 流模式无响应超时时间（秒），默认为300
- **GEMINI_VISION_MAX_IMAGE_NUM**: Gemini视觉模式最大图片数量，默认为16

### 安全与会话配置
- **SESSION_SECRET**: 会话密钥，用于加密会话数据
- **NODE_TYPE**: 节点类型，主节点为"master"

**Section sources**
- [.env.example](file://.env.example)
- [constant/env.go](file://constant/env.go)
- [common/env.go](file://common/env.go)

## 数据库配置
数据库配置决定了系统如何与数据存储交互，包括连接参数和性能调优。

### 连接池配置
- **SQL_MAX_IDLE_CONNS**: 数据库最大空闲连接数，默认为100
- **SQL_MAX_OPEN_CONNS**: 数据库最大打开连接数，默认为1000
- **SQL_MAX_LIFETIME**: 数据库连接最大生命周期（秒），默认为60

### 日志数据库
- **LOG_SQL_DSN**: 专门用于存储日志的数据库连接字符串，建议与主数据库分离以提高性能

### SQLite配置
- **SQLITE_PATH**: 当使用SQLite作为数据库时，指定数据库文件的路径

**Section sources**
- [.env.example](file://.env.example)
- [setting/config/config.go](file://setting/config/config.go)

## 缓存配置
缓存系统对提高系统性能至关重要，支持Redis和内存缓存两种模式。

### Redis配置
- **REDIS_CONN_STRING**: Redis连接字符串，支持密码认证和数据库选择
- **SYNC_FREQUENCY**: 缓存同步频率（秒），决定缓存与数据库的同步间隔

### 内存缓存
- **MEMORY_CACHE_ENABLED**: 是否启用内存缓存，默认启用
- **CHANNEL_UPDATE_FREQUENCY**: 渠道信息更新频率（秒），影响缓存刷新

### 批量更新
- **BATCH_UPDATE_ENABLED**: 是否启用批量更新优化
- **BATCH_UPDATE_INTERVAL**: 批量更新间隔时间（秒）

**Section sources**
- [.env.example](file://.env.example)
- [setting/config/config.go](file://setting/config/config.go)

## 安全设置
安全配置确保系统在面对各种威胁时的稳健性。

### 敏感词过滤
- **CheckSensitiveEnabled**: 是否启用敏感词检查，默认为true
- **CheckSensitiveOnPromptEnabled**: 是否在用户输入(prompt)中检查敏感词，默认为true
- **StopOnSensitiveEnabled**: 检测到敏感词时是否立即停止生成，否则进行替换，默认为true
- **SensitiveWords**: 敏感词列表，可通过换行分隔多个词语

### SSRF防护
系统内置SSRF（服务器端请求伪造）防护机制，防止恶意内部网络探测。

### 会话安全
- **SESSION_SECRET**: 必须设置足够长的随机字符串作为会话密钥
- **FORCE_SSL**: 强制HTTPS连接（需在反向代理层配置）

**Section sources**
- [setting/sensitive.go](file://setting/sensitive.go)
- [common/ssrf_protection.go](file://common/ssrf_protection.go)

## 监控与告警
监控配置帮助运维人员及时发现和响应系统问题。

### 自动测试
- **AutoTestChannelEnabled**: 是否启用渠道自动测试
- **AutoTestChannelMinutes**: 渠道自动测试间隔（分钟），默认为10

### 通知限制
- **NotifyLimitCount**: 通知限制计数
- **NotificationLimitDurationMinute**: 通知限制持续时间（分钟）

### 系统状态监控
- **UptimeKumaEnabled**: 是否启用Uptime Kuma状态监控面板
- **AnnouncementsEnabled**: 是否启用系统公告功能

**Section sources**
- [setting/operation_setting/monitor_setting.go](file://setting/operation_setting/monitor_setting.go)
- [setting/console_setting/config.go](file://setting/console_setting/config.go)

## 运营设置
运营配置支持业务运营的各种需求。

### 演示站点
- **DemoSiteEnabled**: 是否启用演示站点模式，启用后限制部分功能

### 自用模式
- **SelfUseModeEnabled**: 是否启用自用模式，启用后关闭注册等功能

### 自动禁用关键词
系统会自动检测API返回中的特定错误信息并自动禁用失效渠道：
- "Your credit balance is too low"
- "This organization has been disabled."
- "You exceeded your current quota"
- "Permission denied"
- "The security token included in the request is invalid"
- "Operation not allowed"
- "Your account is not authorized"

**Section sources**
- [setting/operation_setting/operation_setting.go](file://setting/operation_setting/operation_setting.go)

## 高级功能配置
高级配置提供了更精细的控制能力。

### 速率限制
- **ModelRequestRateLimitEnabled**: 是否启用模型请求速率限制
- **ModelRequestRateLimitDurationMinutes**: 速率限制统计周期（分钟）
- **ModelRequestRateLimitCount**: 总请求次数限制
- **ModelRequestRateLimitSuccessCount**: 成功请求次数限制
- **ModelRequestRateLimitGroup**: 按用户组设置的速率限制规则

### 比例暴露
- **exposeRatioEnabled**: 是否启用比例暴露功能，控制是否向用户显示详细的配额比例信息

### 模型设置
- **PassThroughRequestEnabled**: 是否启用请求透传模式
- **ThinkingModelBlacklist**: 思考模型黑名单，指定不进行后缀处理的模型

**Section sources**
- [setting/rate_limit.go](file://setting/rate_limit.go)
- [setting/ratio_setting/expose_ratio.go](file://setting/ratio_setting/expose_ratio.go)
- [setting/model_setting/global.go](file://setting/model_setting/global.go)

## 支付网关设置
支付配置支持多种支付方式的集成。

### Stripe支付
- **STRIPE_PUBLISHABLE_KEY**: Stripe公钥
- **STRIPE_SECRET_KEY**: Stripe私钥
- **STRIPE_WEBHOOK_SECRET**: Stripe webhook密钥

### Creem支付
- **CREEM_MERCHANT_ID**: Creem商户ID
- **CREEM_SECRET_KEY**: Creem密钥
- **CREEM_CALLBACK_URL**: Creem回调URL

### 充值选项
- **AmountOptions**: 充值金额选项数组，如[10, 20, 50, 100, 200, 500]
- **AmountDiscount**: 金额折扣映射，如{100: 0.9}表示100元充值享受9折

**Section sources**
- [setting/operation_setting/payment_setting.go](file://setting/operation_setting/payment_setting.go)
- [setting/payment_stripe.go](file://setting/payment_stripe.go)
- [setting/payment_creem.go](file://setting/payment_creem.go)

## OIDC认证配置
OIDC（OpenID Connect）配置支持第三方身份提供商集成。

### 基础设置
- **Enabled**: 是否启用OIDC认证
- **ClientId**: OIDC客户端ID
- **ClientSecret**: OIDC客户端密钥

### 端点配置
- **WellKnown**: OIDC发现文档URL
- **AuthorizationEndpoint**: 授权端点URL
- **TokenEndpoint**: 令牌端点URL
- **UserInfoEndpoint**: 用户信息端点URL

### 特定提供商配置
系统支持多种OIDC提供商，包括：
- LinuxDo: 预配置了LinuxDo的认证端点
- GitHub: 支持GitHub OAuth2集成
- Discord: 支持Discord OAuth2集成

**Section sources**
- [setting/system_setting/oidc.go](file://setting/system_setting/oidc.go)
- [controller/oidc.go](file://controller/oidc.go)

## 配置生效方式与风险
了解配置的生效机制和潜在风险对于安全运维至关重要。

### 配置生效方式
- **环境变量**: 在服务启动时读取，修改后需要重启服务
- **数据库配置**: 通过管理界面修改后立即生效，系统定期从数据库加载最新配置
- **运行时配置**: 部分配置支持运行时动态更新，无需重启服务

### 配置变更风险
- **数据库连接变更**: 错误的连接字符串可能导致服务无法启动
- **缓存配置变更**: 不当的缓存设置可能导致数据不一致或性能下降
- **安全设置变更**: 过于宽松的安全设置可能引入安全漏洞
- **速率限制变更**: 过于严格的限制可能影响正常用户使用

### 回滚策略
建议在修改重要配置前：
1. 备份当前配置
2. 在测试环境验证变更
3. 逐步在生产环境应用
4. 准备好回滚方案

**Section sources**
- [setting/config/config.go](file://setting/config/config.go)
- [common/env.go](file://common/env.go)

## 配置文件示例
以下是完整的配置文件示例：

```env
# 基础配置
PORT=3000
FRONTEND_BASE_URL=https://your-domain.com

# 数据库配置
SQL_DSN=user:password@tcp(localhost:3306)/newapi?parseTime=true
SQL_MAX_IDLE_CONNS=100
SQL_MAX_OPEN_CONNS=1000

# 缓存配置
REDIS_CONN_STRING=redis://localhost:6379/0
MEMORY_CACHE_ENABLED=true

# 安全配置
SESSION_SECRET=your-random-secret-string
CheckSensitiveEnabled=true

# OIDC配置
oidc.enabled=true
oidc.client_id=your-client-id
oidc.client_secret=your-client-secret
oidc.well_known=https://provider.com/.well-known/openid-configuration
```

**Section sources**
- [.env.example](file://.env.example)

## 最佳实践建议
遵循以下最佳实践可确保系统稳定高效运行。

### 安全最佳实践
- 定期轮换`SESSION_SECRET`
- 敏感配置项使用环境变量而非配置文件
- 限制数据库账户权限，遵循最小权限原则

### 性能最佳实践
- 合理配置数据库连接池大小
- 启用Redis缓存以减轻数据库压力
- 定期监控缓存命中率

### 运维最佳实践
- 建立配置变更审批流程
- 实施配置版本控制
- 定期审查和清理过期配置

### 监控最佳实践
- 设置关键指标告警（CPU、内存、数据库连接等）
- 监控API错误率和响应时间
- 记录配置变更日志

**Section sources**
- [setting/config/config.go](file://setting/config/config.go)
- [common/env.go](file://common/env.go)