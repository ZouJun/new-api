# 基础配置

<cite>
**本文档引用文件**   
- [channel.go](file://model/channel.go)
- [channel_settings.go](file://dto/channel_settings.go)
- [channel.go](file://controller/channel.go)
- [channel_select.go](file://service/channel_select.go)
- [common.go](file://common/constants.go)
- [channel_cache.go](file://model/channel_cache.go)
- [ChannelsColumnDefs.jsx](file://web/src/components/table/channels/ChannelsColumnDefs.jsx)
- [other_setting.md](file://docs/channel/other_setting.md)
</cite>

## 目录
1. [渠道基础配置概述](#渠道基础配置概述)
2. [核心字段详解](#核心字段详解)
3. [权重与优先级选择策略](#权重与优先级选择策略)
4. [分组与模型列表配置](#分组与模型列表配置)
5. [配置示例](#配置示例)

## 渠道基础配置概述

渠道基础配置是AI API网关系统的核心组成部分，用于定义和管理不同AI服务提供商的接入参数。每个渠道（Channel）代表一个具体的AI服务实例，通过配置其ID、名称、类型、密钥、状态、权重、优先级、分组、模型列表、标签、备注等字段，系统能够智能地路由请求并实现负载均衡。

渠道配置不仅决定了API请求的转发目标，还影响着系统的稳定性、性能和成本控制。通过合理的配置，管理员可以实现多服务商的无缝集成、故障自动转移、流量按需分配等高级功能。

**Section sources**
- [channel.go](file://model/channel.go#L21-L58)
- [channel.go](file://controller/channel.go#L19-L45)

## 核心字段详解

### 渠道ID (id)
- **数据类型**: `int`
- **描述**: 渠道的唯一标识符，由系统自动生成并递增。
- **约束条件**: 必须为正整数，全局唯一。
- **业务逻辑**: 作为数据库主键，用于精确查询和更新特定渠道。

### 名称 (name)
- **数据类型**: `string`
- **描述**: 渠道的显示名称，便于管理员识别。
- **约束条件**: 必填字段，最大长度未在代码中明确限制，但建议保持简洁。
- **业务逻辑**: 在管理界面中显示，用于人工识别和搜索。

### 类型 (type)
- **数据类型**: `int`
- **描述**: 定义渠道所对接的AI服务提供商类型。
- **约束条件**: 必须为预定义的常量值，如 `ChannelTypeOpenAI=1`, `ChannelTypeAnthropic=14` 等。
- **业务逻辑**: 决定API请求的适配器（adaptor）和基础URL。系统根据类型选择正确的请求格式和认证方式。

### 密钥 (key)
- **数据类型**: `string`
- **描述**: 用于向AI服务提供商进行身份认证的API密钥。
- **约束条件**: 必填字段，不能为空。
- **业务逻辑**: 支持单密钥和多密钥模式。多密钥模式下，密钥以换行符或JSON数组格式存储，系统会根据配置的轮询模式（随机或顺序）选择使用。

### 状态 (status)
- **数据类型**: `int`
- **描述**: 表示渠道的当前运行状态。
- **约束条件**: 预定义常量，包括 `ChannelStatusEnabled=1` (已启用), `ChannelStatusManuallyDisabled=2` (手动禁用), `ChannelStatusAutoDisabled=3` (自动禁用)。
- **业务逻辑**: 系统在选择渠道时，只会考虑状态为“已启用”的渠道。状态可由管理员手动修改，也可由系统根据错误率等指标自动调整。

### 权重 (weight)
- **数据类型**: `*uint`
- **描述**: 在相同优先级的渠道中，决定流量分配比例的相对权重。
- **约束条件**: 可选字段，默认值为0。值越大，分配到的流量越多。
- **业务逻辑**: 与优先级配合使用。在相同优先级的渠道组内，系统根据权重进行加权随机选择。

### 优先级 (priority)
- **数据类型**: `*int64`
- **描述**: 定义渠道的优先等级，数值越大优先级越高。
- **约束条件**: 可选字段，默认值为0。
- **业务逻辑**: 系统首先按优先级从高到低选择渠道。只有当高优先级的所有渠道都不可用时，才会降级到低优先级的渠道。

### 分组 (group)
- **数据类型**: `string`
- **描述**: 将渠道进行逻辑分组，便于批量管理和按组路由。
- **约束条件**: 可选字段，默认值为"default"。支持多个分组，以逗号分隔。
- **业务逻辑**: 用户或应用可以指定使用特定分组的渠道。管理员可以对整个分组执行启用、禁用、编辑等批量操作。

### 模型列表 (models)
- **数据类型**: `string`
- **描述**: 列出该渠道支持的AI模型名称。
- **约束条件**: 可选字段。模型名称以逗号分隔。
- **业务逻辑**: 系统在路由请求时，会检查目标模型是否在渠道的模型列表中。这确保了请求不会被发送到不支持该模型的渠道。

### 标签 (tag)
- **数据类型**: `*string`
- **描述**: 为渠道添加自定义标签，用于聚合管理和快速筛选。
- **约束条件**: 可选字段，支持索引。
- **业务逻辑**: 与“分组”类似，但更灵活，可用于任何自定义分类。支持基于标签的批量操作。

### 备注 (remark)
- **数据类型**: `*string`
- **描述**: 用于记录渠道的额外信息或说明。
- **约束条件**: 可选字段，最大长度255字符。
- **业务逻辑**: 仅用于管理员参考，不影响系统运行。

**Section sources**
- [channel.go](file://model/channel.go#L21-L50)
- [ChannelsColumnDefs.jsx](file://web/src/components/table/channels/ChannelsColumnDefs.jsx#L45-L152)
- [channel.go](file://controller/channel.go#L530-L532)

## 权重与优先级选择策略

渠道的选择策略是系统高可用和负载均衡的核心。其工作流程如下：

1.  **按优先级排序**: 系统首先将所有可用渠道按 `priority` 字段从高到低排序。
2.  **按重试次数降级**: 如果在最高优先级的渠道组中，所有渠道都因错误而不可用（或达到重试上限），系统会自动降级到次高优先级的渠道组。
3.  **在同优先级组内按权重分配**: 当确定了要使用的优先级后，系统会在该优先级的所有渠道中，根据 `weight` 字段进行加权随机选择。
    -   如果所有渠道的权重都为0，则系统会将每个渠道视为权重100，实现平均分配。
    -   如果平均权重小于10，则会对权重进行放大（乘以100），以增加随机选择的平滑度。

```mermaid
flowchart TD
Start([开始选择渠道]) --> SortByPriority["按优先级从高到低排序"]
SortByPriority --> CheckAvailability["检查最高优先级组的可用性"]
CheckAvailability --> |可用| SelectByWeight["在该组内按权重随机选择"]
CheckAvailability --> |不可用| NextPriority["尝试下一个优先级组"]
NextPriority --> CheckAvailability
SelectByWeight --> ReturnChannel["返回选中的渠道"]
ReturnChannel --> End([结束])
```

**Diagram sources **
- [channel_cache.go](file://model/channel_cache.go#L105-L180)
- [channel_select.go](file://service/channel_select.go#L83-L162)

**Section sources**
- [channel_cache.go](file://model/channel_cache.go#L105-L180)
- [channel_select.go](file://service/channel_select.go#L83-L162)

## 分组与模型列表配置

### 分组 (group) 的作用

分组是实现精细化流量控制的关键。其主要用途包括：

- **环境隔离**: 可以创建 `prod` (生产)、`dev` (开发)、`test` (测试) 等分组，将不同环境的渠道隔离开来。
- **服务商隔离**: 可以创建 `openai`、`anthropic`、`gemini` 等分组，按服务商管理渠道。
- **功能隔离**: 可以创建 `chat`、`image`、`audio` 等分组，按功能类型管理渠道。

管理员可以通过API或管理界面，对整个分组执行启用、禁用、编辑等操作，极大地提高了管理效率。

### 模型列表 (models) 的作用

模型列表定义了渠道的能力边界。其业务逻辑如下：

- **路由过滤**: 当用户请求一个特定模型（如 `gpt-4-turbo`）时，系统会遍历所有可用渠道，只选择那些 `models` 字段中包含该模型名称的渠道。
- **动态更新**: 管理员可以手动编辑模型列表，也可以通过“获取上游模型”功能，让系统自动从服务商API拉取最新的模型列表并更新。
- **模型映射**: 通过 `model_mapping` 字段，可以实现模型名称的映射。例如，将用户请求的 `gpt-4` 映射到渠道实际支持的 `gpt-4-0314`。

**Section sources**
- [channel.go](file://model/channel.go#L37-L38)
- [channel.go](file://controller/channel.go#L192-L285)

## 配置示例

### OpenAI 渠道配置

```json
{
  "id": 1,
  "name": "OpenAI 主渠道",
  "type": 1,
  "key": "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "status": 1,
  "weight": 50,
  "priority": 10,
  "group": "openai,prod",
  "models": "gpt-3.5-turbo,gpt-4,gpt-4-turbo",
  "tag": "us-east",
  "remark": "由美国东部数据中心提供支持"
}
```

### Claude 渠道配置

```json
{
  "id": 2,
  "name": "Anthropic Claude 渠道",
  "type": 14,
  "key": "sk-ant-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "status": 1,
  "weight": 30,
  "priority": 8,
  "group": "anthropic,prod",
  "models": "claude-2,claude-instant-1",
  "tag": "high-performance",
  "remark": "支持长上下文"
}
```

### 多密钥渠道配置 (Vertex AI)

```json
{
  "id": 3,
  "name": "Google Vertex AI",
  "type": 41,
  "key": "[\"{\\\"type\\\": \\\"service_account\\\", ...}\", \"{\\\"type\\\": \\\"service_account\\\", ...}\"]",
  "status": 1,
  "weight": 20,
  "priority": 6,
  "group": "vertex,prod",
  "models": "gemini-pro,gemini-pro-vision",
  "tag": "multi-key",
  "remark": "使用JSON数组存储多个服务账号密钥"
}
```

**Section sources**
- [channel.go](file://model/channel.go#L21-L58)
- [other_setting.md](file://docs/channel/other_setting.md#L1-L34)