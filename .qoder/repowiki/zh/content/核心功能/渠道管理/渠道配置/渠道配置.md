# 渠道配置

<cite>
**本文档引用文件**   
- [channel.go](file://controller/channel.go)
- [channel.go](file://model/channel.go)
- [channel_settings.go](file://dto/channel_settings.go)
- [multi_key_mode.go](file://constant/multi_key_mode.go)
- [other_setting.md](file://docs/channel/other_setting.md)
- [api_request.go](file://relay/channel/api_request.go)
- [model_mapped.go](file://relay/helper/model_mapped.go)
- [channel_cache.go](file://model/channel_cache.go)
</cite>

## 目录
1. [渠道基础信息配置](#渠道基础信息配置)
2. [高级设置配置](#高级设置配置)
3. [多密钥模式配置](#多密钥模式配置)
4. [渠道额外设置](#渠道额外设置)
5. [Setting字段与JSON参数](#setting字段与json参数)
6. [模型映射转换](#模型映射转换)
7. [典型AI服务配置示例](#典型ai服务配置示例)

## 渠道基础信息配置

渠道基础信息是配置渠道的核心部分，包含渠道的名称、类型、密钥等关键属性。这些信息定义了渠道的基本身份和连接方式。

在系统中，渠道基础信息通过`Channel`结构体进行管理，主要包含以下字段：

- **名称 (Name)**: 渠道的标识名称，用于在管理界面中识别和显示
- **类型 (Type)**: 渠道的服务类型，如OpenAI、Claude、Gemini等，通过`ChannelType`常量定义
- **密钥 (Key)**: 用于身份验证的API密钥，支持单密钥和多密钥模式
- **状态 (Status)**: 渠道的启用状态，包括启用、手动禁用和自动禁用
- **分组 (Group)**: 渠道所属的分组，用于权限和流量控制
- **优先级 (Priority)**: 在多个渠道中选择时的优先级权重
- **权重 (Weight)**: 在负载均衡中的权重值

渠道的创建和管理通过API接口实现，支持单个添加、批量添加和多密钥模式添加等多种方式。

**Section sources**
- [channel.go](file://model/channel.go#L21-L58)
- [channel.go](file://controller/channel.go#L569-L667)

## 高级设置配置

高级设置提供了对渠道行为的精细化控制，主要包括模型映射、参数覆盖和请求头覆盖等功能。

### 模型映射 (Model Mapping)

模型映射功能允许将请求中的模型名称转换为目标渠道支持的模型名称。这在不同AI服务提供商的模型命名不一致时特别有用。

### 参数覆盖 (Param Override)

参数覆盖允许为渠道设置默认的请求参数，这些参数会覆盖客户端请求中的相应参数。参数覆盖使用JSON格式配置，例如：
```json
{
    "temperature": 0.7,
    "max_tokens": 2000
}
```

### 请求头覆盖 (Header Override)

请求头覆盖允许自定义发送到上游服务的HTTP请求头。支持变量替换，如`{api_key}`会被替换为实际的API密钥。在代码实现中，请求头覆盖通过`processHeaderOverride`函数处理，支持动态变量替换。

**Section sources**
- [channel.go](file://model/channel.go#L48-L49)
- [api_request.go](file://relay/channel/api_request.go#L41-L58)
- [channel.go](file://controller/channel.go#L775-L797)

## 多密钥模式配置

多密钥模式支持在一个渠道中配置多个API密钥，并通过不同的策略进行密钥选择和轮换。

### 多密钥模式类型

系统支持两种多密钥模式：

```mermaid
graph TD
A[多密钥模式] --> B[随机模式]
A --> C[轮询模式]
```

**Diagram sources**
- [multi_key_mode.go](file://constant/multi_key_mode.go#L3-L8)

#### 随机模式 (Random Mode)

随机模式从所有可用的密钥中随机选择一个密钥进行请求。这种模式适用于密钥之间没有特定顺序要求的场景。

#### 轮询模式 (Polling Mode)

轮询模式按照预定义的顺序依次使用密钥，确保每个密钥都能均匀地被使用。轮询模式通过`MultiKeyPollingIndex`字段记录当前轮询位置，确保在多实例部署时也能保持一致的轮询行为。

多密钥模式的实现包含以下关键特性：
- 线程安全的轮询锁机制，通过`GetChannelPollingLock`函数为每个渠道ID创建独立的互斥锁
- 密钥状态管理，跟踪每个密钥的启用/禁用状态
- 自动故障转移，当某个密钥失效时自动切换到下一个可用密钥

**Section sources**
- [channel.go](file://model/channel.go#L61-L67)
- [channel.go](file://model/channel.go#L105-L189)
- [channel_cache.go](file://model/channel_cache.go#L67-L84)

## 渠道额外设置

渠道额外设置通过`Setting`字段存储JSON格式的配置参数，用于控制渠道的特定行为。

### 支持的配置选项

根据文档说明，渠道额外设置支持以下配置项：

- **force_format**: 布尔值，是否强制格式化为OpenAI格式
- **thinking_to_content**: 布尔值，是否将思考内容转换为`<think>`标签
- **proxy**: 字符串，网络代理地址
- **pass_through_body_enabled**: 布尔值，是否启用请求体透传
- **system_prompt**: 字符串，系统提示词
- **system_prompt_override**: 布尔值，是否覆盖系统提示词

### 其他设置 (Other Settings)

除了`Setting`字段外，系统还提供了`OtherSettings`字段用于存储特定服务的配置：

- **AzureResponsesVersion**: Azure服务的响应版本
- **VertexKeyType**: Vertex AI的密钥类型（JSON或API Key）
- **OpenRouterEnterprise**: 是否启用OpenRouter企业功能
- **AwsKeyType**: AWS服务的密钥类型

```mermaid
classDiagram
class ChannelSettings {
+ForceFormat bool
+ThinkingToContent bool
+Proxy string
+PassThroughBodyEnabled bool
+SystemPrompt string
+SystemPromptOverride bool
}
class ChannelOtherSettings {
+AzureResponsesVersion string
+VertexKeyType VertexKeyType
+OpenRouterEnterprise *bool
+AllowServiceTier bool
+DisableStore bool
+AllowSafetyIdentifier bool
+AwsKeyType AwsKeyType
}
ChannelSettings <|-- ChannelOtherSettings
```

**Diagram sources**
- [channel_settings.go](file://dto/channel_settings.go#L3-L42)
- [other_setting.md](file://docs/channel/other_setting.md#L1-L34)

**Section sources**
- [channel_settings.go](file://dto/channel_settings.go#L3-L42)
- [other_setting.md](file://docs/channel/other_setting.md#L1-L34)

## Setting字段与JSON参数

`Setting`字段是渠道配置中的核心部分，用于存储和解析JSON格式的渠道参数。

### 数据结构与存储

`Setting`字段在数据库中以text类型存储，对应Go语言中的`*string`指针类型。这种设计允许字段为空值，同时支持存储任意长度的JSON字符串。

```go
Setting *string `json:"setting" gorm:"type:text"`
```

### 序列化与反序列化

系统提供了完整的序列化和反序列化支持：

- **GetSetting()**: 从JSON字符串反序列化为`ChannelSettings`对象
- **SetSetting()**: 将`ChannelSettings`对象序列化为JSON字符串

当解析JSON配置失败时，系统会记录错误日志并清空设置，防止后续操作受到影响。

### 错误处理

在处理`Setting`字段时，系统实现了完善的错误处理机制：
- JSON格式验证：确保配置是有效的JSON格式
- 默认值处理：对于缺失的字段使用合理的默认值
- 错误恢复：当配置损坏时自动恢复到安全状态

**Section sources**
- [channel.go](file://model/channel.go#L47)
- [channel.go](file://model/channel.go#L874-L894)

## 模型映射转换

模型映射转换功能通过`ModelMappedHelper`函数实现，负责将请求中的模型名称映射到目标渠道支持的模型名称。

### 映射逻辑

模型映射的处理流程如下：

```mermaid
flowchart TD
Start([开始]) --> ParseMapping["解析模型映射JSON"]
ParseMapping --> CheckExists{"映射存在?"}
CheckExists --> |否| ReturnOriginal["返回原始模型名称"]
CheckExists --> |是| StartChain["开始链式映射"]
StartChain --> GetCurrent["获取当前模型"]
GetCurrent --> CheckMapped{"存在映射?"}
CheckExists --> |否| ReturnCurrent["返回当前模型"]
CheckMapped --> |是| CheckCycle{"检测循环?"}
CheckCycle --> |是| Error["返回循环错误"]
CheckCycle --> |否| UpdateCurrent["更新当前模型"]
UpdateCurrent --> StartChain
```

**Diagram sources**
- [model_mapped.go](file://relay/helper/model_mapped.go#L13-L58)

### 链式映射与循环检测

系统支持链式模型映射，即一个模型可以映射到另一个模型，后者再映射到第三个模型。为了防止无限循环，系统实现了循环检测机制：

- **访问记录**: 使用`visitedModels`映射记录已访问的模型
- **循环检测**: 当发现要映射到已访问的模型时，判断是否存在循环
- **终止条件**: 如果循环存在且不是自映射，则返回错误

### 性能优化

模型映射功能在性能方面进行了优化：
- **缓存机制**: 映射关系在请求处理过程中保持在内存中
- **快速查找**: 使用哈希表实现O(1)时间复杂度的模型查找
- **预处理**: 在请求处理早期阶段完成模型映射，避免重复计算

**Section sources**
- [model_mapped.go](file://relay/helper/model_mapped.go#L13-L58)

## 典型AI服务配置示例

以下是几种典型AI服务的配置参数示例，展示了不同服务的特有配置需求。

### OpenAI配置示例

```json
{
    "name": "OpenAI主渠道",
    "type": 1,
    "key": "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "base_url": "https://api.openai.com",
    "model_mapping": "{\"gpt-3.5-turbo\":\"gpt-3.5-turbo-1106\"}",
    "param_override": "{\"temperature\":0.7,\"max_tokens\":2000}",
    "setting": "{\"force_format\":true,\"proxy\":\"socks5://proxy.example.com:1080\"}"
}
```

### Claude配置示例

```json
{
    "name": "Claude渠道",
    "type": 14,
    "key": "sk-ant-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "base_url": "https://api.anthropic.com",
    "model_mapping": "{\"claude-2\":\"claude-2.1\"}",
    "header_override": "{\"x-api-key\":\"{api_key}\"}",
    "setting": "{\"thinking_to_content\":true}"
}
```

### Gemini配置示例

```json
{
    "name": "Gemini渠道",
    "type": 24,
    "key": "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
    "base_url": "https://generativelanguage.googleapis.com",
    "model_mapping": "{\"gemini-pro\":\"models/gemini-pro\"}",
    "param_override": "{\"temperature\":0.9}",
    "other_settings": "{\"allow_service_tier\":false,\"disable_store\":true}"
}
```

### 多密钥模式配置示例

```json
{
    "name": "多密钥OpenAI",
    "type": 1,
    "key": "sk-xxxxxxxx1\nsk-xxxxxxxx2\nsk-xxxxxxxx3",
    "channel_info": {
        "is_multi_key": true,
        "multi_key_size": 3,
        "multi_key_mode": "random",
        "multi_key_polling_index": 0
    },
    "setting": "{\"force_format\":true}"
}
```

这些配置示例展示了如何根据不同的AI服务特性进行针对性配置，确保系统能够正确地与各种AI服务提供商进行交互。

**Section sources**
- [channel.go](file://model/channel.go)
- [channel_settings.go](file://dto/channel_settings.go)
- [other_setting.md](file://docs/channel/other_setting.md)